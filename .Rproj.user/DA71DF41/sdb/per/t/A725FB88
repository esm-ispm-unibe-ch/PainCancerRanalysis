{
    "collab_server" : "",
    "contents" : "\nlibrary(devtools)\ninstall_github(\"esm-ispm-unibe-ch/NMAJags\")\nlibrary(NMAJags)\nlibrary(R2jags)\nlibrary(netmeta)\nlibrary(meta)\nlibrary(metafor)\nlibrary(readxl)\n####\n\n\n\n\n##################################################################################\n#\n#   DATA LOADING AND CLEANING \n#\n##################################################################################\n\n\n#Load the data\n#make sure missing data is in empty cells!\nCancerPainDATA <-read_excel(\"~/_mydrive/WHO/Cancer Pain/KQ 1.1-1.3 NMA pain data 1409.xlsx\",na=\"empty\")\nCancerPainDATA1.2=subset(CancerPainDATA,`KQ 1.1 or 1.2`==\"1.2 Maintenance\")\nCancerPainDATA1.2=subset(CancerPainDATA1.2,Arm!=\"zz_Total\")\n#Load the continuous data from Orestis\nCancerPainDATA1.2cont <- read_excel(\"~/_mydrive/WHO/Cancer Pain/CONTINUOUS.imputed.data.xlsx\", \n                                    col_types = c(\"text\", \"numeric\", \"numeric\", \n                                                  \"numeric\", \"numeric\", \"text\", \"numeric\", \n                                                  \"text\", \"text\", \"text\", \"numeric\", \n                                                  \"text\", \"text\", \"text\", \"text\", \"text\", \n                                                  \"text\", \"text\", \"text\", \"text\", \"text\", \n                                                  \"text\", \"numeric\", \"text\", \"numeric\", \n                                                  \"numeric\", \"text\", \"text\", \"text\", \n                                                  \"text\", \"text\", \"text\", \"text\", \"numeric\", \n                                                  \"numeric\", \"text\", \"numeric\", \"text\", \n                                                  \"text\", \"text\", \"numeric\", \"text\", \n                                                  \"numeric\", \"text\", \"text\", \"text\", \n                                                  \"text\", \"text\", \"text\", \"text\", \"text\", \n                                                  \"text\", \"text\", \"text\", \"text\", \"text\", \n                                                  \"text\", \"text\", \"text\", \"text\", \"text\", \n                                                  \"text\", \"text\", \"numeric\", \"text\", \n                                                  \"numeric\", \"numeric\", \"text\", \"numeric\", \n                                                  \"text\", \"numeric\", \"numeric\", \"numeric\", \n                                                  \"numeric\", \"numeric\", \"numeric\", \n                                                  \"numeric\", \"numeric\", \"text\", \"numeric\", \n                                                  \"text\", \"numeric\", \"text\", \"numeric\", \n                                                  \"numeric\", \"numeric\", \"numeric\", \n                                                  \"numeric\", \"numeric\", \"text\", \"text\", \n                                                  \"text\", \"text\", \"text\", \"numeric\", \n                                                  \"numeric\", \"numeric\"))\n\n#Exclude studies with Butorphanol\nCancerPainDATA1.2=subset(CancerPainDATA1.2,treatment.1!=\"Butorphanol\")\nCancerPainDATA1.2cont=subset(CancerPainDATA1.2cont,treatment.1!=\"Butorphanol\")\n#Load the treatment re-coding excel\nDrug_definition <- read_excel(\"~/_mydrive/WHO/Cancer Pain/Drug definition.xlsx\")\n\n#recode the treatments into a new column \"Treatment\"\nCancerPainDATA1.2$Treatment=NA\nCancerPainDATA1.2cont$Treatment=NA\nfor (i in 1:dim(Drug_definition)[1])\n  {\n  CancerPainDATA1.2$Treatment[CancerPainDATA1.2$treatment.1==Drug_definition$Detailed[i]]=Drug_definition$Grouped[i]\n  CancerPainDATA1.2cont$Treatment[CancerPainDATA1.2cont$treatment.1==Drug_definition$Detailed[i]]=Drug_definition$Grouped[i]\n  }\n\n#keep only useful variables\n\nCancerPainDATA1.2dich=subset(CancerPainDATA1.2,select=c(`Study ID`,Year,`Age: Unique`, Arm,`Outcome Limit`,`OVERALL QUALITY`, Scale, Timepoint, `Timepoint Units`,`N Analyzed`,responders,Treatment))\nCancerPainDATA1.2cont=subset(CancerPainDATA1.2cont,select=c(Study.ID,Year,Age..Unique, Arm,OVERALL.QUALITY, Scale, Timepoint, Timepoint.Units,N.Analyzed,responders,Mean..norm, Mean.Chg..norm,SD.change.norm,SD.norm,Treatment))\n\n\n#create the continious outcome y, sd, ncont\n# Get a mixture of change scores and final values\n#-----------------------\n  #give priority to the change data\n  CancerPainDATA1.2cont$y=CancerPainDATA1.2cont$Mean.Chg..norm \n  CancerPainDATA1.2cont$ncont=CancerPainDATA1.2cont$N.Analyzed\n  CancerPainDATA1.2cont$sd=CancerPainDATA1.2cont$SD.change.norm\n  #if change data not reported use final values\n  use.mean=is.na(CancerPainDATA1.2cont$Mean.Chg..norm)|is.na(CancerPainDATA1.2cont$sd)\n  CancerPainDATA1.2cont$y[use.mean]=CancerPainDATA1.2cont$Mean..norm[use.mean]\n  CancerPainDATA1.2cont$sd[use.mean]=CancerPainDATA1.2cont$SD.norm[use.mean]\n\n\n#define 2 datasets, for dichotomous first************\n#*** THIS IS THE OUTPUT OF THIS FIRST PART \nCancerPainDATA1.2dich=subset(CancerPainDATA1.2dich,!is.na(responders))\nCancerPainDATA1.2cont=subset(CancerPainDATA1.2cont,(!is.na(sd))&(!is.na(y)))\n\n\n##################################################################################\n#\n#   Analysis of dichotomous outcome \n#\n##################################################################################\n\n#USING THE CancerPainDATA1.2dich\n#number of studies\nlength(table(CancerPainDATA1.2dich$`Study ID`))\n#number of arms\nsum(table(CancerPainDATA1.2dich$`Study ID`))\ntable(CancerPainDATA1.2dich$Treatment)\n\n\n#######################################\n#### Setup a connected network\n#######################################\n\nCancerPainDATA1.2dich=pool.arms(data=CancerPainDATA1.2dich, studlab=`Study ID`,treat=Treatment, r=responders,n=`N Analyzed`)\nDATApairsd=pairwise(treat=treat,event=r,n=n, data=CancerPainDATA1.2dich, studlab=id, sm= \"OR\")\n#get connected network\nnetconnection(treat1,treat2,studlab, data=DATApairsd, subset=!is.na(TE))\n\n\n#######################################\n#### Finally, NMA\n#######################################\n\n#run NMA and create an object called EFF for efficacy\nEFFd<-netmeta(TE,seTE,treat1,treat2,studlab,data=DATApairsd,  sm=\"OR\",r=\"Placebo\",comb.fixed =F, comb.random = T, tol.multiarm=T,subset=!is.na(TE))\n#netgraph(EFFd, plastic=F, thickness=\"number.of.studies\", multiarm = F, points=T,cex.points=4, number.of.studies =T, col=1)\nforest(EFFd, ref=\"placebo\", sortvar = Pscore,xlab=\"OR\")\n\nnetsplit(EFFd) \ndecomp.design(EFFd)\n\n\n##################################################################################\n#\n#   Analysis of continuous outcome \n#\n##################################################################################\n\n#USING THE CancerPainDATA1.2dich\n#number of studies\nlength(table(CancerPainDATA1.2cont$Study.ID))\n#number of arms\nsum(table(CancerPainDATA1.2cont$Study.ID))\ntable(CancerPainDATA1.2cont$Treatment)\n\n\n#######################################\n#### Setup a connected network\n#######################################\n\nCancerPainDATA1.2cont=pool.arms(data=CancerPainDATA1.2cont, studlab=Study.ID,treat=Treatment, y=y,n=N.Analyzed,sd=sd, type = \"cont\")\nDATApairsc=pairwise(treat=treat,mean=y,n=n, sd=sd, data=CancerPainDATA1.2cont, studlab=id, sm= \"SMD\")\n#get connected network\nnetconnection(treat1,treat2,studlab, data=DATApairsc, subset=!is.na(TE))\n\n\n#######################################\n#### Finally, NMA\n#######################################\n\n#run NMA and create an object called EFF for efficacy\n\nEFFc<-netmeta(TE,seTE,treat1,treat2,studlab,data=DATApairsc,  sm=\"SMD\",r=\"Placebo\",comb.fixed =F, comb.random = T, tol.multiarm=T,subset=!is.na(TE), tau.preset=sqrt(0.1))\nnetgraph(EFFc, plastic=F, thickness=\"number.of.studies\", multiarm = F, points=T,cex.points=4, number.of.studies =T, col=1)\nforest(EFFc, ref=\"Placebo\",sort=-Pscore, xlab=\"SMD\")\n\nnetsplit(EFFc) \ndecomp.design(EFFc)\n\n\n",
    "created" : 1505726099235.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1621133643",
    "id" : "A725FB88",
    "lastKnownWriteTime" : 1505725475,
    "last_content_update" : 1505725475,
    "path" : "~/_mydrive/WHO/Cancer Pain/PainCancerRanalysis/R/Pain analysis.R",
    "project_path" : "R/Pain analysis.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}